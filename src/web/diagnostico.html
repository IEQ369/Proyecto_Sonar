<!DOCTYPE html>
<html>

<head>
    <title>Diagn√≥stico FFT - Proyecto Sonar</title>
    <meta charset="utf-8">
    <style>
        body {
            background: #18131a;
            color: #ffb86b;
            font-family: monospace;
            margin: 20px;
            line-height: 1.6;
        }

        .test-section {
            background: #1a1a22;
            border: 1px solid #00ffae;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .success {
            color: #00ffae;
        }

        .error {
            color: #ff2e9a;
        }

        .warning {
            color: #ffb86b;
        }

        button {
            background: #ff2e9a;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background: #00ffae;
            color: #222;
        }

        canvas {
            background: #111;
            border: 1px solid #ff2e9a;
            display: block;
            margin: 20px auto;
            width: 100%;
            max-width: 800px;
            height: 200px;
        }
    </style>
</head>

<body>
    <h1>üîç Diagn√≥stico FFT - Proyecto Sonar</h1>

    <div class="test-section">
        <h3>1. Verificaci√≥n de Navegador</h3>
        <div id="browser-info"></div>
    </div>

    <div class="test-section">
        <h3>2. Verificaci√≥n de APIs</h3>
        <div id="api-info"></div>
    </div>

    <div class="test-section">
        <h3>3. Test de Permisos</h3>
        <button onclick="testPermissions()">Probar Permisos de Micr√≥fono</button>
        <div id="permissions-result"></div>
    </div>

    <div class="test-section">
        <h3>4. Test de AudioContext</h3>
        <button onclick="testAudioContext()">Probar AudioContext</button>
        <div id="audiocontext-result"></div>
    </div>

    <div class="test-section">
        <h3>5. Test de FFT Completo</h3>
        <button onclick="startFullTest()">Iniciar Test Completo</button>
        <button onclick="stopFullTest()">Detener Test</button>
        <div id="fft-result"></div>
        <canvas id="fftCanvas" width="800" height="200"></canvas>
    </div>

    <script>
        let audioContext = null;
        let analyser = null;
        let stream = null;
        let animationId = null;

        // 1. Verificaci√≥n de Navegador
        function checkBrowser() {
            const info = document.getElementById('browser-info');
            const userAgent = navigator.userAgent;
            const isHTTPS = window.location.protocol === 'https:';

            let html = '<p><strong>User Agent:</strong> ' + userAgent + '</p>';
            html += '<p><strong>Protocolo:</strong> ' + window.location.protocol + '</p>';
            html += '<p><strong>HTTPS:</strong> ' + (isHTTPS ? '<span class="success">‚úÖ S√≠</span>' : '<span class="error">‚ùå No</span>') + '</p>';

            if (!isHTTPS) {
                html += '<p class="warning">‚ö†Ô∏è getUserMedia requiere HTTPS en navegadores modernos</p>';
            }

            info.innerHTML = html;
        }

        // 2. Verificaci√≥n de APIs
        function checkAPIs() {
            const info = document.getElementById('api-info');

            const hasMediaDevices = !!navigator.mediaDevices;
            const hasGetUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            const hasAudioContext = !!(window.AudioContext || window.webkitAudioContext);
            const hasCanvas = !!document.createElement('canvas').getContext;

            let html = '<p><strong>navigator.mediaDevices:</strong> ' + (hasMediaDevices ? '<span class="success">‚úÖ Disponible</span>' : '<span class="error">‚ùå No disponible</span>') + '</p>';
            html += '<p><strong>getUserMedia:</strong> ' + (hasGetUserMedia ? '<span class="success">‚úÖ Disponible</span>' : '<span class="error">‚ùå No disponible</span>') + '</p>';
            html += '<p><strong>AudioContext:</strong> ' + (hasAudioContext ? '<span class="success">‚úÖ Disponible</span>' : '<span class="error">‚ùå No disponible</span>') + '</p>';
            html += '<p><strong>Canvas:</strong> ' + (hasCanvas ? '<span class="success">‚úÖ Disponible</span>' : '<span class="error">‚ùå No disponible</span>') + '</p>';

            info.innerHTML = html;
        }

        // 3. Test de Permisos
        async function testPermissions() {
            const result = document.getElementById('permissions-result');
            result.innerHTML = '<p>Probando permisos...</p>';

            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('getUserMedia no disponible');
                }

                stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });

                result.innerHTML = '<p class="success">‚úÖ Permisos concedidos correctamente</p>';
                result.innerHTML += '<p><strong>Stream activo:</strong> ' + (stream.active ? 'S√≠' : 'No') + '</p>';
                result.innerHTML += '<p><strong>Tracks:</strong> ' + stream.getTracks().length + '</p>';

            } catch (error) {
                result.innerHTML = '<p class="error">‚ùå Error en permisos: ' + error.message + '</p>';
                console.error('Error en permisos:', error);
            }
        }

        // 4. Test de AudioContext
        function testAudioContext() {
            const result = document.getElementById('audiocontext-result');

            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();

                result.innerHTML = '<p class="success">‚úÖ AudioContext creado correctamente</p>';
                result.innerHTML += '<p><strong>Sample Rate:</strong> ' + audioContext.sampleRate + ' Hz</p>';
                result.innerHTML += '<p><strong>Estado:</strong> ' + audioContext.state + '</p>';

                // Crear un oscilador de prueba
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.type = 'sine';
                oscillator.frequency.value = 440;
                gainNode.gain.value = 0.1;

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);

                result.innerHTML += '<p class="success">‚úÖ Test de audio emitido (440Hz, 0.5s)</p>';

            } catch (error) {
                result.innerHTML = '<p class="error">‚ùå Error en AudioContext: ' + error.message + '</p>';
                console.error('Error en AudioContext:', error);
            }
        }

        // 5. Test de FFT Completo
        async function startFullTest() {
            const result = document.getElementById('fft-result');
            const canvas = document.getElementById('fftCanvas');
            const ctx = canvas.getContext('2d');

            try {
                result.innerHTML = '<p>Iniciando test FFT completo...</p>';

                // Obtener stream si no existe
                if (!stream) {
                    stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false
                        }
                    });
                }

                // Crear AudioContext si no existe
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                // Crear analizador
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                source.connect(analyser);

                result.innerHTML = '<p class="success">‚úÖ FFT configurado correctamente</p>';
                result.innerHTML += '<p><strong>FFT Size:</strong> ' + analyser.fftSize + '</p>';
                result.innerHTML += '<p><strong>Frequency Bin Count:</strong> ' + analyser.frequencyBinCount + '</p>';

                // Iniciar visualizaci√≥n
                drawFFT();

            } catch (error) {
                result.innerHTML = '<p class="error">‚ùå Error en test FFT: ' + error.message + '</p>';
                console.error('Error en test FFT:', error);
            }
        }

        function stopFullTest() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }

            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            document.getElementById('fft-result').innerHTML = '<p>Test FFT detenido</p>';
        }

        function drawFFT() {
            if (!analyser) return;

            const canvas = document.getElementById('fftCanvas');
            const ctx = canvas.getContext('2d');
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            analyser.getByteFrequencyData(dataArray);

            // Limpiar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Dibujar espectro
            const barWidth = canvas.width / bufferLength;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                const barHeight = (dataArray[i] / 255) * canvas.height;

                // Color basado en la intensidad
                const intensity = dataArray[i] / 255;
                ctx.fillStyle = `hsl(${120 + intensity * 120}, 70%, ${50 + intensity * 30}%)`;

                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                x += barWidth;
            }

            // Mostrar informaci√≥n de debug
            const maxValue = Math.max(...dataArray);
            const maxIndex = dataArray.indexOf(maxValue);
            const sampleRate = audioContext ? audioContext.sampleRate : 44100;
            const freqBinHz = sampleRate / 2 / bufferLength;
            const maxFreq = maxIndex * freqBinHz;

            document.getElementById('fft-result').innerHTML =
                '<p class="success">‚úÖ FFT funcionando - Pico: ' + maxValue + ' en ' + maxFreq.toFixed(0) + 'Hz</p>';

            animationId = requestAnimationFrame(drawFFT);
        }

        // Inicializar al cargar
        window.addEventListener('load', () => {
            checkBrowser();
            checkAPIs();
        });
    </script>
</body>

</html>